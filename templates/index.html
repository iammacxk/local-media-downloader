<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ultimate Downloader Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@17/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@17/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body { background-color: #f0f2f5; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .loader { border: 3px solid #f3f3f3; border-top: 3px solid #3498db; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .text-ph-orange { color: #FF9900; }
        .ph-badge { background-color: #000000; color: #ff9900; padding: 2px 8px; border-radius: 4px; font-weight: bold; border: 1px solid #ff9900; display: inline-flex; align-items: center; gap: 4px; }
        
        /* ✨ Smooth Progress Bar Animation */
        .progress-bar { 
            transition: width 0.6s cubic-bezier(0.4, 0, 0.2, 1); 
        }
    </style>
</head>
<body>

<div id="root"></div>

<script type="text/babel">
    const { useState, useEffect, useRef, useCallback } = React;

    // --- Helper Functions (Moved outside to be stable) ---
    const getSourceInfo = (url) => {
        if (url.includes('youtube') || url.includes('youtu.be')) return { icon: 'fa-youtube', color: 'text-red-600', name: 'YouTube' };
        if (url.includes('tiktok')) return { icon: 'fa-tiktok', color: 'text-black', name: 'TikTok' };
        if (url.includes('twitter') || url.includes('x.com')) return { icon: 'fa-x-twitter', color: 'text-gray-900', name: 'X (Twitter)' };
        if (url.includes('facebook') || url.includes('fb.watch')) return { icon: 'fa-facebook', color: 'text-blue-700', name: 'Facebook' };
        if (url.includes('instagram')) return { icon: 'fa-instagram', color: 'text-pink-600', name: 'Instagram' };
        if (url.includes('pornhub')) return { type: 'ph', name: 'Pornhub' };
        return { icon: 'fa-globe', color: 'text-gray-500', name: 'Web' };
    };

    const RenderSourceBadge = ({ source }) => {
        if (source.type === 'ph') return <span className="text-xs ph-badge"><i className="fa-solid fa-play"></i> {source.name}</span>;
        return <span className={`text-xs flex items-center gap-1 font-semibold ${source.color}`}><i className={`fa-brands ${source.icon}`}></i> {source.name}</span>;
    };

    // --- ✨ Animated Counter Component (ตัวเลขวิ่ง) ---
    const AnimatedCounter = ({ value }) => {
        const [displayValue, setDisplayValue] = useState(0);
        
        useEffect(() => {
            let startValue = displayValue;
            let endValue = value;
            let startTime = null;
            const duration = 500; // 0.5 วินาทีในการวิ่งไปหาค่าใหม่

            const step = (timestamp) => {
                if (!startTime) startTime = timestamp;
                const progress = Math.min((timestamp - startTime) / duration, 1);
                
                // สูตร Ease Out (ให้ตัวเลขวิ่งเร็วตอนต้น แล้วช้าตอนปลาย)
                const ease = 1 - Math.pow(1 - progress, 3);
                
                const current = startValue + (endValue - startValue) * ease;
                setDisplayValue(current);

                if (progress < 1) {
                    window.requestAnimationFrame(step);
                }
            };
            
            window.requestAnimationFrame(step);
        }, [value]);

        return <span>{displayValue.toFixed(1)}%</span>;
    };

    // --- Queue Item Component ---
    const QueueItem = React.memo(({ item, onRemove, onUpdateProgress }) => {
        const source = getSourceInfo(item.url);

        // Polling Effect
        useEffect(() => {
            let interval;
            if (item.status === 'downloading') {
                // เช็คถี่ขึ้น (ทุก 0.5 วินาที) เพื่อความลื่นไหล
                interval = setInterval(async () => {
                    try {
                        const res = await fetch(`/progress?id=${item.requestId}`);
                        const data = await res.json();
                        if (data) {
                            onUpdateProgress(item.requestId, data);
                        }
                    } catch (e) { console.error(e); }
                }, 500);
            }
            return () => clearInterval(interval);
        }, [item.status, item.requestId, onUpdateProgress]);

        return (
            <div className="bg-white p-3 rounded-lg shadow-sm border flex flex-col gap-2 transition hover:shadow-md animate-fade-in">
                <div className="flex items-center gap-4">
                    {/* Status Icon */}
                    <div className="w-10 flex justify-center flex-shrink-0">
                        {item.status === 'waiting' && <i className="fa-regular fa-clock text-gray-400 text-xl"></i>}
                        {item.status === 'downloading' && <div className="loader"></div>}
                        {item.status === 'done' && <i className="fa-solid fa-check-circle text-green-500 text-xl transition transform scale-110"></i>}
                        {item.status === 'error' && <i className="fa-solid fa-circle-exclamation text-red-500 text-xl"></i>}
                    </div>

                    {/* Info */}
                    <div className="flex-1 min-w-0">
                        <div className="font-medium text-gray-800 truncate" title={item.title}>{item.title}</div>
                        <div className="flex items-center gap-3 mt-1 flex-wrap">
                            <RenderSourceBadge source={source} />
                            <div className="text-xs flex gap-2 items-center">
                                <span className={`px-2 py-0.5 rounded text-white font-bold shadow-sm ${item.type==='mp3'?'bg-blue-500':'bg-indigo-500'}`}>{item.type.toUpperCase()}</span>
                                {item.status === 'error' && <span className="text-red-500 truncate max-w-xs font-medium" title={item.error}>{item.error}</span>}
                                {item.status === 'waiting' && <span className="text-gray-400">รอคิว...</span>}
                                {item.status === 'done' && <span className="text-green-600 font-bold">เสร็จสิ้น</span>}
                            </div>
                        </div>
                    </div>

                    {/* Buttons */}
                    <div className="flex gap-2 flex-shrink-0">
                        {item.status === 'done' && (
                            <a href={item.downloadUrl} className="w-8 h-8 flex items-center justify-center bg-green-100 text-green-600 hover:bg-green-600 hover:text-white rounded-full transition shadow-sm" title="Save File">
                                <i className="fa-solid fa-download"></i>
                            </a>
                        )}
                        {item.status !== 'downloading' && (
                            <button onClick={() => onRemove(item.id)} className="w-8 h-8 flex items-center justify-center text-gray-400 hover:bg-red-100 hover:text-red-500 rounded-full transition">
                                <i className="fa-solid fa-trash"></i>
                            </button>
                        )}
                    </div>
                </div>

                {/* ✨ Smooth Progress Bar Area */}
                {item.status === 'downloading' && (
                    <div className="pl-14 pr-2 pb-1">
                        <div className="flex justify-between text-xs text-gray-500 mb-1 font-medium">
                            <span className="flex items-center gap-1">
                                {item.statusText === 'processing' 
                                    ? <span className="text-indigo-500"><i className="fa-solid fa-gear fa-spin mr-1"></i>กำลังแปลงไฟล์...</span> 
                                    : <span><i className="fa-solid fa-bolt text-yellow-500 mr-1"></i>{item.speed}</span>
                                }
                            </span>
                            {/* ใช้ AnimatedCounter ตรงนี้ */}
                            <AnimatedCounter value={item.progress} />
                        </div>
                        <div className="w-full bg-gray-100 rounded-full h-2.5 overflow-hidden shadow-inner">
                            <div 
                                className={`h-2.5 rounded-full progress-bar shadow-sm ${item.statusText === 'processing' ? 'bg-indigo-500' : 'bg-gradient-to-r from-blue-400 to-blue-600'}`} 
                                style={ { width: `${item.progress}%` } }
                            ></div>
                        </div>
                    </div>
                )}
            </div>
        );
    });

    function App() {
        const [urlInput, setUrlInput] = useState('');
        const [formatType, setFormatType] = useState('mp3');
        const [fetchLoading, setFetchLoading] = useState(false);
        const [playlistData, setPlaylistData] = useState(null);
        const [selectedItems, setSelectedItems] = useState({});
        const [queue, setQueue] = useState([]);
        const [isProcessingQueue, setIsProcessingQueue] = useState(false);

        const handleFetch = async () => {
            if (!urlInput) return;
            setFetchLoading(true);
            setPlaylistData(null);
            try {
                const res = await fetch('/fetch-info', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ url: urlInput })
                });
                const data = await res.json();
                if (data.error) throw new Error(data.error);
                if (!data.is_playlist) {
                    addToQueue(data.entries[0]);
                    setUrlInput('');
                } else {
                    setPlaylistData(data);
                    const initialSelected = {};
                    data.entries.forEach(e => initialSelected[e.id] = true);
                    setSelectedItems(initialSelected);
                }
            } catch (err) {
                alert('เกิดข้อผิดพลาด: ' + err.message);
            } finally {
                setFetchLoading(false);
            }
        };

        const addToQueue = (item) => {
            setQueue(prev => {
                if (prev.find(q => q.id === item.id)) return prev;
                const requestId = Date.now().toString() + Math.random().toString(36).substr(2, 9);
                return [...prev, {
                    ...item,
                    requestId: requestId,
                    status: 'waiting',
                    type: formatType,
                    addedAt: Date.now(),
                    progress: 0,
                    speed: '-',
                    eta: '-'
                }];
            });
        };

        const addSelectedToQueue = () => {
            if (!playlistData) return;
            const itemsToAdd = playlistData.entries.filter(e => selectedItems[e.id]);
            itemsToAdd.forEach(item => addToQueue(item));
            setPlaylistData(null);
            setUrlInput('');
        };

        useEffect(() => {
            if (isProcessingQueue) return;
            const nextItem = queue.find(q => q.status === 'waiting');
            if (nextItem) processDownload(nextItem);
        }, [queue, isProcessingQueue]);

        const processDownload = async (item) => {
            setIsProcessingQueue(true);
            updateQueueStatus(item.requestId, { status: 'downloading' }); // ใช้ Request ID อัปเดต
            try {
                const res = await fetch('/download', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ url: item.url, type: item.type, requestId: item.requestId })
                });
                const data = await res.json();
                if (data.error) throw new Error(data.error);
                updateQueueStatus(item.requestId, { status: 'done', downloadUrl: data.download_url });
            } catch (err) {
                updateQueueStatus(item.requestId, { status: 'error', error: err.message });
            } finally {
                setIsProcessingQueue(false);
            }
        };

        // ฟังก์ชันอัปเดต state ที่เสถียรขึ้น (ใช้ useCallback)
        const updateQueueStatus = useCallback((reqId, updates) => {
            setQueue(prev => prev.map(q => q.requestId === reqId ? { ...q, ...updates } : q));
        }, []);

        const handleProgressUpdate = useCallback((reqId, data) => {
             setQueue(prev => prev.map(q => 
                q.requestId === reqId 
                ? { ...q, progress: data.percent, speed: data.speed, eta: data.eta, statusText: data.status } 
                : q
            ));
        }, []);

        const removeFromQueue = (id) => setQueue(prev => prev.filter(q => q.id !== id));
        const toggleSelect = (id) => setSelectedItems(prev => ({...prev, [id]: !prev[id]}));

        return (
            <div className="min-h-screen p-4 md:p-8 flex flex-col md:flex-row gap-6 max-w-7xl mx-auto">
                {/* Left Panel */}
                <div className="w-full md:w-1/3 space-y-4">
                    <div className="bg-white p-6 rounded-xl shadow-xl border border-gray-100">
                        <h1 className="text-2xl font-bold mb-1 text-gray-800 flex items-center">
                            <i className="fa-solid fa-cloud-arrow-down text-blue-600 mr-2"></i> 
                            Local Downloader Pro
                        </h1>
                        <p className="text-xs text-gray-400 mb-5 pl-10">  โหลดวิดีโอ/เพลง คุณภาพสูง รองรับ 4K</p>
                        
                        <div className="space-y-3">
                            <div className="relative">
                                <i className="fa-solid fa-link absolute left-3 top-3 text-gray-400"></i>
                                <input type="text" value={urlInput} onChange={(e) => setUrlInput(e.target.value)} placeholder="วางลิงก์ที่นี่..." className="w-full pl-10 pr-4 py-2.5 rounded-lg border border-gray-200 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition shadow-sm"/>
                            </div>
                            
                            <div className="flex gap-2">
                                <button onClick={() => setFormatType('mp3')} className={`flex-1 py-2.5 rounded-lg text-sm font-bold border transition transform active:scale-95 ${formatType==='mp3'?'bg-blue-600 border-blue-600 text-white shadow-md':'bg-white text-gray-600 border-gray-200 hover:bg-gray-50'}`}><i className="fa-solid fa-music mr-1"></i> MP3 (Audio)</button>
                                <button onClick={() => setFormatType('mp4')} className={`flex-1 py-2.5 rounded-lg text-sm font-bold border transition transform active:scale-95 ${formatType==='mp4'?'bg-indigo-600 border-indigo-600 text-white shadow-md':'bg-white text-gray-600 border-gray-200 hover:bg-gray-50'}`}><i className="fa-solid fa-video mr-1"></i> MP4 (Video)</button>
                            </div>
                            <button onClick={handleFetch} disabled={fetchLoading || !urlInput} className="w-full py-3 bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-700 hover:to-indigo-700 text-white rounded-lg font-bold shadow-lg transition flex justify-center items-center disabled:opacity-50 disabled:cursor-not-allowed transform active:scale-95">
                                {fetchLoading ? <span className="flex items-center"><div className="loader w-4 h-4 border-white border-t-transparent mr-2"></div> กำลังดึงข้อมูล...</span> : <span><i className="fa-solid fa-plus mr-2"></i> เพิ่มลงคิว</span>}
                            </button>
                        </div>
                    </div>

                    {playlistData && (
                        <div className="bg-white p-4 rounded-xl shadow-lg border-2 border-blue-50 animate-fade-in">
                            <div className="flex justify-between items-center mb-3">
                                <h3 className="font-bold text-gray-700 truncate max-w-[200px]" title={playlistData.title}>{playlistData.title}</h3>
                                <div className="text-xs space-x-2">
                                    <button onClick={() => { const all = {}; playlistData.entries.forEach(e => all[e.id]=true); setSelectedItems(all); }} className="text-blue-600 hover:underline font-medium">เลือกทั้งหมด</button>
                                    <button onClick={() => setSelectedItems({})} className="text-gray-500 hover:underline">ล้าง</button>
                                </div>
                            </div>
                            <div className="max-h-64 overflow-y-auto space-y-1 mb-3 pr-1 scrollbar-thin">
                                {playlistData.entries.map((entry, idx) => (
                                    <div key={entry.id} className={`flex items-center p-2 rounded cursor-pointer transition ${selectedItems[entry.id] ? 'bg-blue-50' : 'hover:bg-gray-50'}`} onClick={() => toggleSelect(entry.id)}>
                                        <div className={`w-5 h-5 flex items-center justify-center mr-3 rounded border ${selectedItems[entry.id] ? 'bg-blue-500 border-blue-500 text-white' : 'border-gray-300 bg-white'}`}>
                                            {selectedItems[entry.id] && <i className="fa-solid fa-check text-xs"></i>}
                                        </div>
                                        <div className="text-sm truncate flex-1 text-gray-700">{idx+1}. {entry.title}</div>
                                    </div>
                                ))}
                            </div>
                            <div className="flex gap-2">
                                <button onClick={() => setPlaylistData(null)} className="flex-1 py-2 text-gray-600 hover:bg-gray-100 rounded-lg font-medium">ยกเลิก</button>
                                <button onClick={addSelectedToQueue} className="flex-1 py-2 bg-green-500 hover:bg-green-600 text-white rounded-lg font-bold shadow transition"><i className="fa-solid fa-check mr-1"></i> ยืนยัน ({Object.values(selectedItems).filter(Boolean).length})</button>
                            </div>
                        </div>
                    )}
                </div>

                {/* Right Panel */}
                <div className="w-full md:w-2/3">
                    <div className="bg-white rounded-xl shadow-xl overflow-hidden flex flex-col h-[80vh] border border-gray-100">
                        <div className="p-4 border-b bg-gray-50/50 flex justify-between items-center backdrop-blur-sm">
                            <h2 className="font-bold text-gray-700 flex items-center"><i className="fa-solid fa-list-check mr-2 text-blue-500"></i> รายการรอโหลด <span className="ml-2 bg-blue-100 text-blue-600 px-2 py-0.5 rounded-full text-xs">{queue.length}</span></h2>
                            <div className="text-xs font-medium text-gray-500">เสร็จแล้ว {queue.filter(q => q.status === 'done').length} รายการ</div>
                        </div>

                        <div className="flex-1 overflow-y-auto p-4 space-y-3 bg-gray-50/30">
                            {queue.length === 0 ? (
                                <div className="h-full flex flex-col items-center justify-center text-gray-400">
                                    <div className="w-24 h-24 bg-gray-100 rounded-full flex items-center justify-center mb-4">
                                        <i className="fa-solid fa-basket-shopping text-4xl text-gray-300"></i>
                                    </div>
                                    <p className="font-medium">ยังไม่มีรายการในคิว</p>
                                    <p className="text-sm mt-1">เลือกเพลงจากด้านซ้ายได้เลย</p>
                                </div>
                            ) : (
                                queue.map((item, index) => (
                                    <QueueItem 
                                        key={item.requestId} 
                                        item={item} 
                                        onRemove={removeFromQueue} 
                                        onUpdateProgress={handleProgressUpdate} 
                                    />
                                ))
                            )}
                        </div>
                    </div>
                </div>
            </div>
        );
    }
    ReactDOM.render(<App />, document.getElementById('root'));
</script>
</body>
</html>